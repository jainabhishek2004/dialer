<button 
  onclick="fetchCallLogs()" 
  style="background-color: #013D4D; color: white; padding: 12px 24px; font-size: 16px; border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.3s ease, transform 0.2s ease;"
  onmouseover="this.style.backgroundColor='#02657A'; this.style.transform='scale(1.05)'"
  onmouseout="this.style.backgroundColor='#013D4D'; this.style.transform='scale(1)'"
>
  ðŸ“ž Fetch Call Logs
</button>

<p id="callStatus" style="margin-top: 20px; font-weight: bold;"></p>

<script src="https://cdn.jsdelivr.net/npm/@pipedrive/app-extensions-sdk@latest/dist/index.umd.js"></script>

<script>
  async function fetchCallLogs() {
    console.log("hello logs")
    try {
      const response = await fetch("http://localhost:3000/fetch-logs");
      if (!response.ok) throw new Error(`Server error: ${response.status}`);
      const data = await response.json();
      console.log("ðŸ‘¥ All persons from Pipedrive:", data);
    } catch (error) {
      console.error("âŒ Error fetching persons:", error.message);
    }
  }

  fetchCallLogs();

 
  setInterval(fetchCallLogs, 30 * 60 * 1000); 

  (async () => {
    const urlParams = new URLSearchParams(window.location.search);
    const iframeURL = window.location.href;
    const token = urlParams.get('token');
    const userId = urlParams.get('userId');
    const companyId = urlParams.get('companyId');
    const id = urlParams.get('id');

    console.log("ðŸŒ Iframe URL:", iframeURL);
    console.log("ðŸ‘¤ User ID:", userId);
    console.log("ðŸ¢ Company ID:", companyId);
    console.log("ðŸ†” Surface ID:", id);

    const sdk = await new AppExtensionsSDK().initialize();
    const { Command, Event } = window.AppExtensionsSDK;
    await sdk.execute(Command.RESIZE, { height: 580, width: 400 });
    await sdk.execute(Command.SHOW_FLOATING_WINDOW);

    sdk.listen(Event.VISIBILITY, (event) => {
      const context = event?.data?.context;
      const callToNumber = context?.callToNumber;
      const personId = event?.data?.relatedIds?.personId;

      if (callToNumber) {
        console.log("ðŸ“² Call to number:", callToNumber);
        // DialByLine should be defined or replaced
        // DialByLine('audio', null, callToNumber, null, null);

        const callStatusEl = document.getElementById("callStatus");
        if (callStatusEl) {
          callStatusEl.textContent = `Calling to ${callToNumber}`;
        }

        if (personId) {
          console.log("ðŸ‘¤ Person ID:", personId);
        }

        if (context?.person) {
          console.log("ðŸ“ž Person context:", context.person);
        }
      }
    });
  })();
</script>


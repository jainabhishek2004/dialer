<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Dialer</title>
</head>
<body>
  <h1>Click to Call Dialer</h1>
  <h1 id="callStatus">Calling to ...</h1> <!-- Add an ID here -->
</body>

<script src="https://cdn.jsdelivr.net/npm/@pipedrive/app-extensions-sdk@0.2.0-rc.0/dist/index.umd.js"></script>
<script>
  (async () => {
    const urlParams = new URLSearchParams(window.location.search);

    const iframeURL = window.location.href;
    const token = urlParams.get('token');
    const userId = urlParams.get('userId');
    const companyId = urlParams.get('companyId');
    const id = urlParams.get('id');

    console.log("ðŸŒ Iframe URL:", iframeURL);
    console.log("ðŸ” Token:", token);
    console.log("ðŸ‘¤ User ID:", userId);
    console.log("ðŸ¢ Company ID:", companyId);
    console.log("ðŸ†” Surface ID:", id);

    const sdk = await new AppExtensionsSdk().initialize();
    console.log("âœ… SDK initialized");

    try {
      const response = await fetch("http://localhost:3001/api/fetch-logs", {
        method: "GET"
      });

      if (!response.ok) {
        throw new Error(`Server error: ${response.status}`);
      }

      const data = await response.json();
      console.log("ðŸ‘¥ All persons from Pipedrive:", data);
    } catch (error) {
      console.error("âŒ Error fetching persons:", error.message);
    }

    sdk.listen(AppExtensionsSdk.Event.VISIBILITY, (event) => {
      const context = event?.data?.context;
      const callToNumber = context?.callToNumber;
      const personId = event?.data?.relatedIds?.personId;

      if (context) {
        console.log(context);
      }

      if (callToNumber) {
        console.log("ðŸ“² Call to number:", callToNumber);

        // ðŸ‘‰ Update the DOM with the number
        const callStatusEl = document.getElementById("callStatus");
        callStatusEl.textContent = `Calling to ${callToNumber}`;

        if (personId) {
          console.log("ðŸ‘¤ Person ID:", personId);
        }

        if (context?.person) {
          console.log("ðŸ“ž Person context:", context.person);
        }
      }
    });
  })();
</script>
</html>
